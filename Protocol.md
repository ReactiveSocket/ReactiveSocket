## Introduction

Key words used by this document conform to the meanings in [RFC 2119](https://tools.ietf.org/html/rfc2119).

## Terminology

* __Frame__: A frame of data containing a request or a response.
* __Transport__: Protocol used to carry ReactiveSockets protocol. One of WebSockets, TCP, or Aeron. The transport is assumed
to provide [reliable delivery](https://en.wikipedia.org/wiki/Reliability_(computer_networking)).
* __Stream__: Unit of operation (request/response, etc.). See [Design Principles](DesignPrinciples.md).
* __Request__: A stream request. May be one of four types. As well as request for more items or cancellation of previous request.
* __Response__: A stream response. Contains data associated with previous request.
* __Client__: The side initiating a connection.
* __Server__: The side accepting connections from clients.
* __Connection__: The instance of a transport session between client and server.
* __Requester__: The side sending a request. A connection has at most 2 Requesters. One in each direction.
* __Responder__: The side receiving a request. A connection has at most 2 Responders. One in each direction.

## Data And Metadata

ReactiveSocket provides mechanisms for applications to distinguish payload into two types. Data and Metadata. The distinction
between the types in an application is left to the application.

The following are features of Data and Metadata.

- Metadata can be encoded differently than Data.
- Metadata can be "attached" (i.e. correlated) with the following entities:
    - Connection via Metadata Push and Stream ID of 0
    - Stream via Metadata Push and Stream ID of non-0
    - Individual Response via Metadata header

## Operation

### Frame Header Format

ReactiveSocket frames begin with a header. The general layout is given below. When used over
transport protocols that provide framing (WebSocket and Aeron), the Frame Length field is not included.
For transports that do not provide framing, such as TCP, the Frame Length MUST be included.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |I|M|  Flags    |         Frame Type            |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                           Depends on Frame Type
```

* __Frame Length__: (31 = max 2,147,483,647 bytes) Length of Frame. Including header. Only used for TCP. The __R__ bit
is reserved.
* __Version__: (8) Current version is 0.
* __Flags__: Any Flag bit not specifically indicated in the frame type should be set to 0 when sent and not interpreted on
reception.
     * (__I__)gnore: Ignore frame if not understood
     * (__M__)etadata: Metadata present
* __Frame Type__: (16) Type of Frame.
* __Stream ID__: (64) Stream Identifier for this frame.

#### Metadata Optional Header

Specific Frame Types MAY contain an optional metadata header that provides metadata about a frame.
This metadata header is between the Frame Header and any payload.

Metadata Length MUST be less than or equal to the Frame Length minus the length of the Frame Header.
If Metadata Length is greater than this value, the entire frame MUST be ignored.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |       Type    |           Metadata Length                     |
    +---------------+-----------------------------------------------+
    |                       Metadata Payload                       ...
    +---------------------------------------------------------------+
    |                       Payload of Frame                       ...
    +---------------------------------------------------------------+
```

* __Type__: Application-defined Type field for the metadata. Not interpretted by protocol.
* __Metadata Length__: (24 = max 16,777,216 bytes) Length of Metadata. Including Metadata header.

### Stream Identifiers

#### Generation

Stream IDs are generated by a Requester. The lifetime of a Stream ID is determined by the request type and
the semantics of the stream based on its type.

Stream ID value of 0 is reserved for any operation involving the connection.

A stream ID must be locally unique for a Requester in a connection.

A client MUST generate even Stream IDs.

A server MUST generate odd Stream IDs.

### Frame Types

|  Type                          | Value  | Description |
|:-------------------------------|:-------|:------------|
| __RESERVED__                   | 0x0000 | __Reserved__ |
| __SETUP__                      | 0x0001 | __Setup__: Capabilities Of Side Sending The Frame. |
| __SETUP_ERROR__                | 0x0002 | __Setup Error__: Error from SETUP. |
| __LEASE__                      | 0x0003 | __Lease__: |
| __KEEPALIVE__                  | 0x0004 | __Keepalive__: Connection keepalive. |
| __REQUEST_RESPONSE__           | 0x0011 | __Request Response__: |
| __REQUEST_FNF__                | 0x0012 | __Fire And Forget__: |
| __REQUEST_STREAM__             | 0x0013 | __Request Stream__: |
| __REQUEST_SUB__                | 0x0014 | __Request Subscription__: |
| __REQUEST_CHANNEL__            | 0x0015 | __Request Channel__: |
| __REQUEST_N__                  | 0x0020 | __Request N__: Request N more items |
| __CANCEL__                     | 0x0021 | __Cancel Request__: |
| __RESPONSE__                   | 0x0030 | __Response__: Response to a request. |
| __ERROR__                      | 0x0031 | __Error__: Response that is an error. |
| __METADATA_PUSH__              | 0x0041 | __Metadata__: Asynchronous Metadata frame |
| __EXT__                        | 0xFFFF | __Extension Header__: Used To Extend More Options As Well As Extensions. |

__NOTE__: In general Requesters send types 0x0010 to 0x001F and Responders send types 0x0020 to 0x002F. Types 0x0001 to 0x000F
pertain to the entire connection. Types 0x0030 to 0x003F pertain to all levels depending on context.

### Setup Frame

Setup frames MUST always use Stream ID 0 as they pertain to the connection.

The encoding format for Data and Metadata are included separately in the SETUP.

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-+-+-------+-------------------------------+
    |    Version    |0|M|L|S| Flags |     Frame Type = SETUP        |
    +---------------+-+-+-+-+-------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                   Time Between KEEPALIVE Frames               |
    +---------------------------------------------------------------+
    |                         Max Lifetime                          |
    +---------------+-----------------------------------------------+
    |  MIME Length  |   Metadata Encoding MIME Type                ...
    +---------------+-----------------------------------------------+
    |  MIME Length  |     Data Encoding MIME Type                  ...
    +---------------+-----------------------------------------------+
                          Metadata & Setup Payload
```

* __Flags__:
     * (__M__)etadata: Metdadata present
     * (__L__): Will honor LEASE (or not).
     * (__S__)trict: Adhere to strict interpretation of Data and Metadata.
* __Time Between KEEPALIVE Frames__: Time (in nanoseconds) between KEEPALIVE frames that the client will send.
* __Max Lifetime __: Time (in nanoseconds) that a client will allow a server to not respond to a KEEPALIVE before
it is assumed to be dead.
* __MIME Length__: Encoding MIME Type Length in bytes.
* __Encoding MIME Type__: MIME Type for encoding of Data and Metadata. This is a US-ASCII string
that includes the [Internet media type](https://en.wikipedia.org/wiki/Internet_media_type) specified
in [RFC 2045](https://tools.ietf.org/html/rfc2045). Many are registered with
[IANA](https://www.iana.org/assignments/media-types/media-types.xhtml) such as
[CBOR](https://www.iana.org/assignments/media-types/application/cbor)
* __Setup Data__: includes payload describing connection capabilities of the endpoint sending the
Setup header.

__NOTE__: [Suffix](http://www.iana.org/assignments/media-type-structured-suffix/media-type-structured-suffix.xml)
rules SHOULD be used for handling layout. For example, `application/x.netflix+cbor` or 
`application/x.reactivesocket+cbor` or `application/x.netflix+json`.

### Setup Error Frame

Setup Error frames MUST always use Stream ID 0 as they pertain to the connection.

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    |     Frame Type = SETUP_ERROR  |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                          Error Code                           |
    +---------------------------------------------------------------+
                        Metadata & Setup Error Data
```

* __Flags__:
     * (__M__)etadata: Metdadata present
* __Error Code__: Type of Error.
* __Setup Error Data__: includes payload describing error information. Error Data MUST be a UTF-8 encoded string.

#### Error Codes

|  Type                          | Value  | Description |
|:-------------------------------|:-------|:------------|
| __RESERVED__                   | 0x0000 | __Reserved__ |
| __INVALID_SETUP__              | 0x0001 | The Setup frame is invalid for the server (it could be that the client is too recent for the old server) |
| __UNSUPPORTED_SETUP__          | 0x0010 | Some (or all) of the parameters specified by the client are unsupported by the server |
| __REJECTED_SETUP__             | 0x0100 | The server rejected the setup, it can specify the reason in the payload |
| __RESERVED__                   | 0xFFFF | __Reserved for Extension Use__ |

### Lease Frame

Lease frames MUST always use Stream ID 0 as they pertain to the Connection.

Lease frames MAY be sent by the client-side or server-side Responders and inform the
Requester that it may send Requests for a period of time and how many it may send.

The last received LEASE frame overrides all previous LEASE frame values.

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    |     Frame Type = LEASE        |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                         Time-To-Live                          |
    |                                                               |
    +---------------------------------------------------------------+
    |                       Number of Requests                      |
    |                                                               |
    +---------------------------------------------------------------+
                                Metadata
```

* __Flags__:
     * (__M__)etadata: Metdadata present
* __Time-To-Live (TTL)__: Time (in nanoseconds) for validity of LEASE from time of reception
* __Number of Requests__: Number of Requests that may be sent until next LEASE

A Responder implementation MAY stop all further requests by sending a LEASE with a value of 0 for __Number of Requests__.

When a LEASE expires due to time, the value of the __Number of Requests__ that a Requester may make is implicitly 0.

### Keepalive Frame

KEEPALIVE frames MUST always use Stream ID 0 as they pertain to the Connection.

KEEPALIVE frames MUST be initiated by the client and sent periodically.

Reception of a KEEPALIVE frame on a server indicates the client is alive. A server
MUST send a KEEPALIVE frame back to the client upon reception of a KEEPALIVE.

A client may add data to a KEEPALIVE frame that is echoed back on the KEEPALIVE frame
to the client.

A reasonable time interval between KEEPALIVE frames SHOULD be 500ms.

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|0|  Flags    |     Frame Type = KEEPALIVE    |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                                  Data
```

* __Flags__:
     * (__M__)etadata: Metdadata __never__ present
* __Data__: Data attached to a KEEPALIVE from the client and echoed back by the server.

### Request Response Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    | Frame Type = REQUEST_RESPONSE |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                         Metadata & Request Data
```

* __Flags__:
     * (__M__)etadata: Metdadata present
* __Request Data__: identification of the service being requested along with parameters for the request.

### Request Fire-n-Forget Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    |    Frame Type = REQUEST_FNF   |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                          Metadata & Request Data
```

* __Flags__:
     * (__M__)etadata: Metdadata present
* __Request Data__: identification of the service being requested along with parameters for the request.

### Request Stream Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    |  Frame Type = REQUEST_STREAM  |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                      Initial Request N                        |
    |                                                               |
    +---------------------------------------------------------------+
                          Metadata & Request Data
```

* __Flags__:
     * (__M__)etadata: Metdadata present
* __Request Data__: identification of the service being requested along with parameters for the request.
* __Initial Request N__: initial request N value for stream.

### Request Subscription Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (For TCP Only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    |    Frame Type = REQUEST_SUB   |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream Id                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                      Initial Request N                        |
    |                                                               |
    +---------------------------------------------------------------+
                           Metadata & Request Data
```

* __Flags__:
     * (__M__)etadata: Metdadata present
* __Request Data__: idientification of the service being requested along with parameters for the request.
* __Initial Request N__: initial request N value for subscription.

### Request Channel Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (For TCP Only)                 |
    +---------------+-+-+-+-+-+-----+-------------------------------+
    |    Version    |0|M|F|C|N|     |  Frame Type = REQUEST_CHANNEL |
    +---------------+-+-+-+-+-+-----+-------------------------------+
    |                           Stream Id                           |
    |                                                               |
    +---------------------------------------------------------------+
    |              Initial Request N (only if N bit set)            |
    |                                                               |
    +---------------------------------------------------------------+
                           Metadata & Request Data
```

* __Flags__:
    * (__M__)etadata: Metdadata present
    * (__F__)ollows: More fragments follow this fragment.
    * (__C__)omplete: bit to indicate COMPLETE.
    * (__N__): Is Initial Request N present or not
* __Request Data__: idientification of the service being requested along with parameters for the request.
* __Initial Request N__: initial request N value for channel.

### Request N Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|0|   Flags   |     Frame Type = REQUEST_N    |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                           Request N                           |
    |                                                               |
    +---------------------------------------------------------------+
```

* __Flags__:
     * (__M__)etadata: Metdadata __NOT__ present
* __Request N__: 64-bit integer value of items to request.

### Cancel Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    |     Frame Type = CANCEL       |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                                Metadata
```

* __Flags__:
     * (__M__)etadata: Metdadata present

### Response Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-+-+-------+-------------------------------+
    |    Version    |0|M|F|C|       |    Frame Type = RESPONSE      |
    +---------------+-+-+-+-+-------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                         Metadata & Response Data
```

* __Flags__:
    * (__M__)etadata: Metadata Present.
    * (__F__)ollows: More fragments follow this fragment.
    * (__C__)omplete: bit to indicate COMPLETE.
* __Response Data__: payload for onNext.

A Response is generally referred to as a NEXT.

A Response with the Complete Bit set is referred to as a COMPLETE.

#### Error Frame

An ERROR frame is used as a means of communicating a stream ERROR from a Responder to a Requester.

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M| Reserved  |      Frame Type = ERROR       |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                          Error Code                           |
    +---------------------------------------------------------------+
                           Metadata & Error Data
```

* __Flags__:
     * (__M__)etadata: Metdadata present
* __Error Code__: Type of Error.
* __Error Data__: error information. Error Data MUST be a UTF-8 encoded string.

#### Error Codes

|  Type                          | Value  | Description |
|:-------------------------------|:-------|:------------|
| __RESERVED__                   | 0x0000 | __Reserved__ |
| __APPLICATION_ERROR__          | 0x0001 | The application on top of reactivesocket responded with an error |
| __REJECTED__                   | 0x0010 | Despite being a valid request, the reactivesocket responder decided to reject it. The responder guarantees that it didn't process the request. The reason for the rejection is explained in the metadata section. |
| __CANCELED__                   | 0x0011 | The responder cancelled the request but potentially have started processing it (almost identical to REJECTED but doesn't garantee that no side-effect have been started). |
| __INVALID__                    | 0x8000 | The request is invalid in the context of this reactivesocket  |
| __RESERVED__                   | 0xFFFF | __Reserved for Extension Use__ |


### Metadata Push Frame

A Metadata Push frame can be used to send asynchronous metadata notifications from a Requester or
Responder to its peer. Metadata MUST be scoped to the connection by setting Stream ID to 0.

Metadata tied to a particular Request, Response, etc. uses the individual frames Metadata flag.

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|1| Reserved  |   Frame Type = METADATA_PUSH  |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                                Metadata
```

* __Flags__:
     * (__M__)etadata: Metdadata _always_ present
* __Stream ID__: May be 0 to pertain to the entire connection or non-0 value to
pertain to just that Stream.

### Extension Frame

The general format for an extension frame is given below.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |I|M|  Flags    |     Frame Type = EXT          |
    +---------------+-+-+-----------+-------------------------------+
    |                        Extended Type                          |
    +---------------------------------------------------------------+
                          Depends on Extended Type...
```

* __Frame Type__: (16) 0xFFFF for Extension Header.
* __Flags__:
    * (__I__)gnore: Can be frame be ignored if not understood?
    * (__M__)etadata: Metadata Present.
* __Extended Type__: Extended type information

## Connection Establishment

__NOTE__: The semantics are similar to [TLS False Start](https://tools.ietf.org/html/draft-bmoeller-tls-falsestart-00).

Immediately upon successful connection, the client MUST send a SETUP frame with
Stream ID of 0. Any other frame received that is NOT a SETUP frame or a SETUP frame with
a non-0 Stream ID, MUST cause the server to send a SETUP_ERROR (with INVALID_SETUP) and close connection.

The client-side Requester can inform the server-side Responder as to whether it will
honor LEASEs or not based on the presence of the __L__ flag in the SETUP frame.

The client-side Requester that has NOT set the __L__ flag in the SETUP frame may send
requests immediately if it so desires without waiting for a LEASE from the server.

The client-side Requester that has set the __L__ flag in the SETUP frame MUST wait
for the server-side Responder to send a LEASE frame before it can send Requests.

If the server accepts the contents of the SETUP frame, it MUST send a LEASE frame if
the SETUP frame set the __L__ flag. The server-side Requester may send requests
immediately upon receiving a SETUP frame that it accepts.

If the server does NOT accept the contents of the SETUP frame, the server MUST send
back a SETUP_ERROR and then close the connection.

The __S__ flag of the SETUP indicates the client requires the server to adhere to strict interpretation
of the Data and Metadata of the SETUP. Anything in the Data and/or Metadata that is not understood or can
be provided by the server should require the SETUP to be rejected.

The server-side Requester mirrors the LEASE requests of the client-side Requester. If a client-side
Requester sets the __L__ flag in the SETUP frame, the server side Requester MUST wait for a LEASE
frame from the client-side Responder before it can send a request. The client-side Responder MUST
send a LEASE frame after a SETUP frame with the __L__ flag set.

A client assumes a SETUP is accepted if it receives a response to a request, a LEASE
frame, or if it sees a REQUEST type.

A client assumes a SETUP is rejected if it receives a SETUP_ERROR.

Until connection establishment is complete, a Requester MUST NOT send any Request frames.

Until connection establishment is complete, a Responder MUST NOT emit any RESPONSE frames.

### Negotiation

The assumption is that the client will be dictating to the server what it desires to do. The server will decide to support
that SETUP (accept it) or not (reject it). The SETUP_ERROR error code indicates the reason for the rejection.

### Sequences without LEASE

The possible sequences without LEASE are below.

1. Client-side Request, Server-side __accepts__ SETUP
    * Client connects & sends SETUP & sends REQUEST
    * Server accepts SETUP, handles REQUEST, sends back normal sequence based on REQUEST type
1. Client-side Request, Server-side __rejects__ SETUP
    * Client connects & sends SETUP & sends REQUEST
    * Server rejects SETUP, sends back SETUP_ERROR, closes connection
1. Server-side Request, Server-side __accepts__ SETUP
    * Client connects & sends SETUP
    * Server accepts SETUP, sends back REQUEST type
1. Server-side Request, Server-side __rejects__ SETUP
    * Client connects & sends SETUP
    * Server rejects SETUP, sends back SETUP_ERROR, closes connection

### Sequences with LEASE

The possible sequences with LEASE are below.

1. Client-side Request, Server-side __accepts__ SETUP
    * Client connects & sends SETUP with __L__ flag
    * Server accepts SETUP, sends back LEASE frame
    * Client-side sends REQUEST
1. Client-side Request, Server-side __rejects__ SETUP
    * Client connects & sends SETUP with __L__ flag
    * Server rejects SETUP, sends back SETUP_ERROR, closes connection
1. Server-side Request, Server-side __accepts__ SETUP
    * Client connects & sends SETUP with __L__ flag
    * Server accepts SETUP, sends back LEASE frame
    * Client sends LEASE frame
    * Server sends REQUEST
1. Server-side Request, Server-side __rejects__ SETUP
    * Client connects & sends SETUP with __L__ flag
    * Server rejects SETUP, sends back SETUP_ERROR, closes connection

## Fragmentation And Reassembly

RESPONSE frames may represent a large object and MAY need to be fragmented to fit within the Frame Data size. When this
occurs, the RESPONSE __F__ flag indicates if more fragments follow this frame.

## Stream Sequences and Lifetimes

In the section below, "RQ -> RS" refers to Requester sending a frame to a Responder. And "RS -> RQ" refers to Responder sending
a frame to a Requester.

In the section below, "*" refers to 0 or more and "+" refers to 1 or more.

### Request Response

1. RQ -> RS: REQUEST_RESPONSE
1. RS -> RQ: RESPONSE with COMPLETE

or

1. RQ -> RS: REQUEST_RESPONSE
1. RS -> RQ: ERROR

or

1. RQ -> RS: REQUEST_RESPONSE
1. RQ -> RS: CANCEL

Upon sending a response, the stream is terminated on the Responder.

Upon receiving a CANCEL, the stream is terminated on the Responder and the response SHOULD not be sent.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a COMPLETE or ERROR, the stream is terminated on the Requester.

### Request Fire-n-Forget

1. RQ -> RS: REQUEST_FNF

Upon reception, the stream is terminated by the Responder.

Upon being sent, the stream is terminated by the Requester.

REQUEST_FNF are assumed to be best effort and MAY not be processed due to: (1) SETUP rejection, (2) mis-formatting, (3) etc.

### Request Stream

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: RESPONSE*
1. RS -> RQ: ERROR

or

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: RESPONSE*
1. RS -> RQ: RESPONSE with COMPLETE

or 

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: RESPONSE*
1. RQ -> RS: CANCEL

At any time, a client may send REQUEST_N frames.

Upon receiving a CANCEL, the stream is terminated on the Responder.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a COMPLETE or ERROR, the stream is terminated on the Requester.

Upon sending a COMPLETE or ERROR, the stream is terminated on the Responder.

### Request Subscription

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: RESPONSE*

or

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: RESPONSE*
1. RS -> RQ: ERROR

or

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: RESPONSE*
1. RQ -> RS: CANCEL

At any time, a client may send REQUEST_N frames.

Upon receiving a CANCEL, the stream is terminated on the Responder.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a ERROR, the stream is terminated on the Requester.

Upon sending a ERROR, the stream is terminated on the Responder.

### Request Channel

1. RQ -> RS: REQUEST_CHANNEL* intermixed with
1. RS -> RQ: RESPONSE*
1. RS -> RQ: COMPLETE | ERROR

or

1. RQ -> RS: REQUEST_CHANNEL* intermixed with
1. RS -> RQ: RESPONSE*
1. RQ -> RS: CANCEL

At any time, a Requester may send REQUEST_CHANNEL frames with F bit set to indicate fragmentation.

At any time, a Requester, as well as a Responder, may send REQUEST_N frames.

A Requester may indicate end of REQUEST_CHANNEL frames by setting the C bit. A Requester MUST NOT
send any additional REQUEST_CHANNEL frames after sending a frame with the C bit set.

Upon receiving a CANCEL, the stream is terminated on the Responder.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a COMPLETE or ERROR, the stream is terminated on the Requester.

Upon sending a COMPLETE or ERROR, the stream is terminated on the Responder.

### Per Stream State

#### Requester

1. CLOSED: implicit starting/ending state of all stream IDs
1. Requested (sent REQUEST_*)
1. CLOSED (received COMPLETE or sent REQUEST_FNF)
1. CLOSED (received ERROR)

#### Responder

1. CLOSED: implicit starting/ending state of all stream IDs
1. Responding: sending RESPONSEs and processing REQUEST_N
1. CLOSED (received CANCEL)
1. CLOSED (sent COMPLETE or received REQUEST_FNF)
1. CLOSED (sent ERROR)

### Flow Control

#### Reactive Stream Semantics

[Reactive Stream](http://www.reactive-streams.org/) semantics for flow control of Streams and Subscriptions.

#### Lease Semantics

Requester MUST respect the LEASE contract. The Requester MUST NOT send more than __Number of Requests__ specified
in the LEASE frame within the __Time-To-Live__ value in the LEASE.

A Responder that receives a REQUEST that it can not honor due to LEASE restrictions MUST either respond with an ERROR or decide to process the request (depending on the implementation). This includes an initial LEASE sent as part of [Connection Establishment](#connection-establishment).

#### Handling the Unexpected

This protocol attempts to be very lenient in processing of received frames and SHOULD ignore
conditions that do not make sense given the current context. Clarifications are given below:

1. TCP half-open connections (and WebSockets) or other dead transports are detectable by lack of KEEPALIVE frames as specified
under [Keepalive Frame](#keepalive-frame). The decision to close a connection due to inactivity is the applications choice.
1. Request keepalive and timeout semantics are the responsibility of the application.
1. Lack of REQUEST_N frames that stops a stream is an application concern and SHALL NOT be handled by the protocol.
1. Lack of LEASE frames that stops new Requests is an application concern and SHALL NOT be handled by the protocol.
1. If a RESPONSE for a REQUEST_RESPONSE is received that does not have a COMPLETE flag set, the implementation MUST
assume it is set and act accordingly.
1. Reassembly of RESPONSES MUST assume the possibility of an infinite stream.
1. Stream ID values MAY be re-used after completion or error of a stream.
1. A RESPONSE with both __F__ and __C__ flags set, implicitly ignores the __F__ flag.
1. All other received frames that are not accounted for in previous sections MUST be ignored. Thus, for example:
    1. Receiving a Request frame on a Stream ID that is already in use MUST be ignored.
    1. Receiving a CANCEL on an unknown Stream ID (including 0) MUST be ignored.
    1. Receiving an ERROR on an unknown Stream ID (including 0) MUST be ignored.
    1. Receiving a RESPONSE on an unknown Stream ID (including 0) MUST be ignored.
    1. Receiving a METADATA_PUSH on an unknown Stream ID MUST be ignored.
	1. A server MUST ignore a SETUP frame after it has accepted a previous SETUP.
	1. A server MUST ignore a SETUP_ERROR frame.
	1. A client MUST ignore a SETUP_ERROR after it has completed connection establishment.
	1. A client MUST ignore a SETUP frame.

##### To Be Specified

## TODO

- [ ] Stream ID should maybe be renamed to Request ID.
- [ ] naming
    - Connection instance
        * Requester instance
        * Responder instance
- [ ] Handling the unexpected section
